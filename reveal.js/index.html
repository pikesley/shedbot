<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content=
    "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    name="viewport">
    <title>
      My Shed Has An API
    </title>
    <link href="css/reveal.css" rel="stylesheet">
    <link href="css/theme/league.css" rel="stylesheet">
		<link href="lib/css/zenburn.css" rel="stylesheet">
		<link href="css/spectrum.css" rel="stylesheet">
		<link href="css/shedbot.css" rel="stylesheet">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-background='images/relay-spider.jpg'>
          <h1>
            My Shed Has An API
          </h1>
          <h2>
            Lessons from a project that got out of hand
          </h2>
          <h3>
            Sam Pikesley
          </h3>
          <p>
            <a href='https://twitter.com/pikesley'>@pikesley</a>
          </p>
          <aside class='notes' data-markdown>
Hello Lunchtime Lecture fans, my name is Sam, and this is a story about gardens, renewable energy, and HTTP

Going on three years ago, I bought a house, with a garden. I'd never had a garden of my own before, but it turns out gardening is amazingly good fun, and in fact if you've spoken to me for more than about five minutes in the last two years, I've almost certainly bored you to death about my beautiful South-facing garden. The question of which way it faces will be important later on
          </aside>
        </section>
        <section data-background='images/garden.jpg'>
          <aside class='notes' data-markdown>
Here's a picture of my garden from June this year

Now it turns out that gardening requires a lot of equipment, and unless you want to really annoy your girlfriend by filling your kitchen with shovels and things, you're going to need a shed
          </aside>
        </section>
        <section data-background='images/shed.jpg'>
          <aside class='notes' data-markdown>
This is my shed. We put this up in the spring of 2014 and it contains a lawnmower and a chainsaw and all the usual sort of shed stuff. However the observant viewer may notice something on the roof
          </aside>
        </section>
        <section data-background='images/panel.jpg'>
          <aside class='notes' data-markdown>
Yes, I mounted a solar panel up there. This panel belonged to my mate Steve, but it's been languishing at his old flat for ages, so when he offered it to sell it, the voltage regulator and a great big mobile-home battery for a very reasonable price, I snapped it up. And so the first lesson is
          </aside>
        </section>
        <section data-background='images/panel.jpg'>
          <h1>
            Lesson #0: Have a mate who wants to get shot of a solar panel
          </h1>
          <aside class='notes' data-markdown>
The panel did not come with any fixings, just a bunch of holes in the underside of the frame. So as you can see, I lashed something together with a few metal straps, some cut-up plastic pipe and some roofing bolts, and I sealed all the holes with silicone sealant and Sugru
          </aside>
        </section>
        <section data-background='images/regulator.jpg'>
          <aside class='notes' data-markdown>
So inside the shed, I connected the voltage regulator to the battery (which I don't have a picture of because it's down behind my potting bench) and then to the panel, and as it was a sunny day and as I mentioned the whole thing points South, everything lit up straight away and I had started gathering Free Energy
          </aside>
        </section>
        <section data-background='images/power-point.jpg'>
          <aside class='notes' data-markdown>
Steve had also thrown in a couple of these power outlets with the panel, which have a 5-volt USB socket on them. So the first thing I plugged in was
          </aside>
        </section>
        <section data-background='images/radio.jpg'>
          <aside class='notes' data-markdown>
the radio. If this seems like a tremendous feat of over-engineering just so I can listen to the Test cricket while I'm gardening, strap yourselves in because we're just getting started

So, what to do with all this Free Energy, apart from my solar-powered Geoffrey Boycott? Well, I thought it might be nice to run some lights down there
          </aside>
        </section>
        <section data-background='images/light.jpg'>
          <aside class='notes' data-markdown>
So I got hold of some cheapo 12-volt lights off eBay, and hooked them up to the power outlets, and there was light

But of course I've still got some spare 5-volt USB connections. What else do we know of that runs off of 5-volts USB? Yes, of course, a Raspberry Pi
          </aside>
        </section>
        <section data-background='images/pi.jpg'>
          <aside class='notes' data-markdown>
This is a Pi 3, with the built-in wifi. So I got Raspbian on there, and eventually a modern Ruby, got it on the network, and then I was able to get a shell on my shed, and how cool is that?

The next step was to see if I could switch the lights with the Pi
          </aside>
        </section>
        <section data-background='images/relay.jpg'>
          <aside class='notes' data-markdown>
So I bought this 12-volt relay and connected the lights (by cutting the live wire and connecting that across the switch) and then I found out that it requires a 5-volt signal to switch it - the Pi's pins will only give 3.3 volts. And so we come to the next lesson:
          </aside>
        </section>
        <section data-background='images/relay.jpg'>
          <h1>
            Lesson #1: Sometimes you need more grunt
          </h1>
          <aside class='notes' data-markdown>
Anyway, this gave me an excuse to play around with
          </aside>
        </section>
        <section data-background='images/arduino.jpg'>
          <aside class='notes' data-markdown>
I've never done any Arduino stuff before and I've gotta be honest, I was a little bit intimidated. However it turns out that's it surprisingly easy, at least for this very simple case
          </aside>
        </section>
        <section data-background='images/arduino.jpg'>
          <pre>
            <code class='c++'>
		int relays[] = { 4, 5, 6, 7 };
		int inputs[] = { 8, 9, 10, 11 };
		int count = 4;
		void setup() {
		  for (int r = 0; r < count; r++) {
		    pinMode(relays[r], OUTPUT);
		    pinMode(inputs[r], INPUT);
		  }
		}
		void loop() {
		  for (int v = 0; v < count; v++) {
		    digitalWrite(relays[v],
		    digitalRead(inputs[v]));
		  }
		}
            </code>
          </pre>
					<a href=
'https://github.com/pikesley/relay-puller'>https://github.com/pikesley/relay-puller</a>
          <aside class='notes' data-markdown>
This code is dead, dead simple: we define four input pins and four output pins, then inside the loop we simply map the state of each input pin to the corresponding output pin. So when Input Pin 1 goes high, Output Pin 1 goes high, which throws Relay Switch 1, which makes a very satisfying 'clunk' noise and switches a light on. So the next lesson is
          </aside>
        </section>
        <section data-background='images/arduino.jpg'>
          <h1>
            Lesson #2: Arduino programming is easier than you think
          </h1>
          <aside class='notes' data-markdown>
So what about the Raspberry Pi end of this?
          </aside>
        </section>
        <section data-background='images/pi.jpg'>
          <aside class='notes' data-markdown>
There is a Ruby Gem called `pi_piper` for controlling the IO pins, and aside from requiring root privileges it's very easy to use. However
          </aside>
        </section>
        <section data-background='images/pi.jpg'>
          <h1>
            Lesson #3: The Raspberry Pi pin layout is an unspeakable shambles
          </h1>
          <h2 class='fragment fade-left'>
            <a href='http://pinout.xyz'>http://pinout.xyz</a>
          </h2>
          <aside class='notes' data-markdown>
The physical pin numbers bear not the slightest relation to the logical pin numbers. There are presumably good reasons for this, but without the Treasure Map provided by

`click`

the fine people at pinout.xyz, I'd have been at a loss
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <h1>
            RESTful API
          </h1>
          <aside class='notes' data-markdown>
So, what about an API?

I broke out my favourite Ruby web framework, Sinatra, and put together a very simple API. The main endpoint is
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    /lights/:light
            </code>
          </pre>
          <aside class='notes' data-markdown>
But then I came up against the issue of which HTTP verb to use. My first, naive thought was do something like
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    GET /lights/:light/on
    GET /lights/:light/off
            </code>
          </pre>
          <aside class='notes' data-markdown>
a GET, but no, a GET is for reading the state of a resource. So maybe a POST then?
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    POST /lights/:light

    {
      state: on
    }
            </code>
          </pre>
          <aside class='notes' data-markdown>
No, that's for creating a resource. Oh wait, maybe a PUT is the thing?
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    PUT /lights/:light

    {
      state: on
    }
            </code>
          </pre>
          <aside class='notes' data-markdown>
But that's for updating a resource. No, after extensive discussions with James and Jeni _who used to sit on the WWW Technical Architecture Group, no less_, we decided that the correct approach, where we're changing the state of part of a resource, is PATCH
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    PATCH /lights/:light

    {
      state: on
    }
            </code>
          </pre>
          <aside class='notes' data-markdown>
and let's face it, if we're not going to do this correctly then the whole thing is rendered ridiculous

So the lesson here is
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <h1>
            Lesson #4: Learn to love the HTTP verbs
          </h1>
          <h2 class='fragment fade-left'>
            (also, waste people's time)
          </h2>
          <aside class='notes' data-markdown>
and also

`click`

This is still not _entirely_ correct - because this is interacting with Real Things in the Real World, I think this should all be done asynchronously, via a _sheduler_, and then there should be another endpoint which reports the actual state of the light. In practice, however, this works just fine as it is

We can send a GET, of course, to get the state of a light
          </aside>
        </section>
        <section data-background='images/house.jpg'>
          <pre>
            <code>
    GET /lights/inside

    {
      inside: on
    }
            </code>
          </pre>
					<a class='fragment fade-left' href=
'https://www.w3.org/2001/tag/group/track/issues/14'>https://www.w3.org/2001/tag/group/track/issues/14</a>
          <aside class='notes' data-markdown>
Except, what are we really getting back here? We're actually asking the server for the light itself, and it sends back a 200 indicating that it's returned what we asked for. But of course it hasn't, it's sent back a representation of the state of the light _and it can't even be sure about that_. It should maybe send back a 303, SEE OTHER, with a URI for the light. Except of course this is a light screwed to my shed, which DOESN'T HAVE A URI

`click`

This rabbit-hole is the HTTP-RANGE-14 problem, which I don't have time to go into now but will be happy to have opinions on afterwards if you come and find me.

So what does this all look like in practice? Well, if you're on my home network and you point your web browser at the Pi, there's a screen like this
          </aside>
        </section>
        <section data-background='images/complete.jpg'>
          <img src='images/screenshot.png'> <a href=
          'https://github.com/pikesley/shedbot'>https://github.com/pikesley/shedbot</a>
          <aside class='notes' data-markdown>
And you can click those switches and turn the lights on and off, which is awesome. HOWEVER there is a massive flaw in all of this: if I don't have my phone with me, then short of pulling wires out I HAVE NO WAY OF CONTROLLING THE LIGHTS. So possibly the most important lesson is
          </aside>
        </section>
        <section data-background='images/complete.jpg'>
          <h1>
            Lesson #5: Install some actual physical switches
          </h1>
          <aside class='notes' data-markdown>
So what else might I do with all this?
          </aside>
        </section>
        <section data-background='images/complete.jpg'>
          <h1>
            What else can I do with this?
          </h1>
          <ul>
            <li class='fragment fade-left'>Use the sunset / sunrise API at
            <a href=
            'http://sunrise-sunset.org/api'>http://sunrise-sunset.org/api</a>
            </li>
            <li class='fragment fade-left'>Implement the SHEDuler (this is
            never going to happen)
            </li>
            <li class='fragment fade-left'>Charge my drill batteries
            </li>
          </ul>
          <aside class='notes' data-markdown>
Well, I have a few ideas:

`click`

I discovered an API which takes a lat / long and tells you the exact times of sunset and sunrise at that location. I thought I might use this to have the lights come on as the sun goes down. It was pointed out to me that you can buy solar lights from Ikea that turn on when it gets dark but I can't help feeling that that completely misses the point

`click`

As mentioned previously, I should really make this happen asynchronously, but that's unlikely ever to actually transpire

`click`

Thinking more widely about what to do with all this free energy, I bought an inverter to recharge the batteries for my cordless drill
          </aside>
        </section>
        <section data-background='images/relay-spider.jpg'>
          <h1>
            Questions?
          </h1>
          <hr>
          <p>
            <a href=
            'http://sam.pikesley.org/projects/shedbot/'>http://sam.pikesley.org/projects/shedbot/</a>
          </p>
          <p>
            <a href=
            'https://github.com/pikesley/relay-puller'>https://github.com/pikesley/relay-puller</a>
          </p>
          <p>
            <a href=
            'https://github.com/jwhitehorn/pi_piper'>https://github.com/jwhitehorn/pi_piper</a>
          </p>
          <p>
            <a href=
            'https://www.w3.org/2001/tag/group/track/issues/14'>https://www.w3.org/2001/tag/group/track/issues/14</a>
          </p>
          <p>
            <a href='http://sam.pikesley.org/'>http://sam.pikesley.org/</a>
          </p>
          <p>
            <a href='https://twitter.com/pikesley'>@pikesley</a>
          </p>
        </section>
      </div>
    </div>
    <script src="lib/js/head.min.js">
    </script>
    <script src="js/reveal.js">
    </script>
    <script>
           // More info https://github.com/hakimel/reveal.js#configuration
           Reveal.initialize({
             history: true,

             // More info https://github.com/hakimel/reveal.js#dependencies
             dependencies: [{
               src: 'plugin/markdown/marked.js'
             }, {
               src: 'plugin/markdown/markdown.js'
             }, {
               src: 'plugin/notes/notes.js',
               async: true
             }, {
               src: 'plugin/highlight/highlight.js',
               async: true,
               callback: function() {
                 hljs.initHighlightingOnLoad();
               }
             }]
           });
    </script>
  </body>
</html>
